<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Post"><!-- namespace - 클래스명과 동일 -->
	<!-- id - 메소드명과 동일 -->
	<!-- resultType : row 1줄의 형태를 지정 -->
	<!-- 쿼리 작성 시 ;이 들어가면 실행되지 않음 -->
	
	<!-- 작품올리기 -->
	<insert id="addPost" parameterType="hashmap">
		INSERT INTO POST(POST_NO, USER_NO, CATEGORY_NO, TITLE, EXPLAIN, POST_FILE, VISIBILITY, REGISTER_DATE)
		VALUES(#{postNo}, #{userNo}, #{category}, #{title}, #{explain}, #{postFile2}, #{public_privacy}, SYSDATE)
	</insert>
	
	<!-- 작품번호 -->
	<select id="getNum" resultType="Integer">
     	SELECT POST_SEQ.NEXTVAL FROM DUAL
	</select>
	
	<!-- 태그 -->
	<select id="getTag" parameterType="String" resultType="hashmap">
     	SELECT TAG_NO
		FROM TAG
		WHERE TAG_NAME = #{tagName}
	</select>
	
	<insert id="addTag" parameterType="String">
		INSERT INTO TAG(TAG_NO, TAG_NAME)
		VALUES(TAG_SEQ.NEXTVAL, #{tagName})
	</insert>
	
	<insert id="addMiddleTag" parameterType="hashmap">
		INSERT INTO POST_TAG(POST_NO, TAG_NO)
		VALUES(#{postNo}, #{TagNo})
	</insert>
	
	<!-- 사진갤러리 페이지 목록 -->
	<select id="picList" parameterType="hashmap" resultType="hashmap">
		SELECT UP.USER_NICKNAME, UP.USER_NO, UP.TITLE, UP.EXPLAIN, UP.POST_FILE, UP.POST_NO,RNUM
		FROM (SELECT U.USER_NICKNAME, U.USER_NO, P.TITLE, P.EXPLAIN, P.POST_FILE, P.POST_NO, ROW_NUMBER() OVER(ORDER BY POST_NO DESC) AS RNUM
			FROM USERS U inner JOIN (SELECT TITLE, EXPLAIN, POST_FILE, USER_NO, POST_NO
			                        FROM POST
			                        WHERE DEL = 1
			                        AND VISIBILITY = 0
			                        AND CATEGORY_NO = 1) P
			                ON U.USER_NO = P.USER_NO
			WHERE U.OUT_DATE IS NULL) UP
			WHERE UP.RNUM BETWEEN #{startCnt} AND #{endCnt}
	</select>

	<!-- 사진갤러리 게시글 수 -->
	<select id="getPicCnt" parameterType="hashmap" resultType="Integer">
     	SELECT COUNT(*) AS CNT 
		FROM USERS U INNER JOIN (SELECT TITLE, EXPLAIN, POST_FILE, USER_NO, POST_NO
		                        FROM POST
		                        WHERE DEL = 1
		                        AND VISIBILITY = 0
		                        AND CATEGORY_NO = 1) P
		                ON U.USER_NO = P.USER_NO
		WHERE U.OUT_DATE IS NULL
	</select>
	
	<!-- 그림갤러리 페이지 목록 -->
	<select id="drawList" parameterType="hashmap" resultType="hashmap">
		SELECT UP.USER_NICKNAME, UP.USER_NO, UP.TITLE, UP.EXPLAIN, UP.POST_FILE, UP.POST_NO,RNUM
		FROM (SELECT U.USER_NICKNAME, U.USER_NO, P.TITLE, P.EXPLAIN, P.POST_FILE, P.POST_NO, ROW_NUMBER() OVER(ORDER BY POST_NO DESC) AS RNUM
			FROM USERS U inner JOIN (SELECT TITLE, EXPLAIN, POST_FILE, USER_NO, POST_NO
			                        FROM POST
			                        WHERE DEL = 1
			                        AND VISIBILITY = 0
			                        AND CATEGORY_NO = 2) P
			                ON U.USER_NO = P.USER_NO
			WHERE U.OUT_DATE IS NULL) UP
		WHERE UP.RNUM BETWEEN #{startCnt} AND #{endCnt}
	</select>
	
	<!-- 그림갤러리 게시글 수 -->
	<select id="getDrawCnt" parameterType="hashmap" resultType="Integer">
     	SELECT COUNT(*) AS CNT 
		FROM USERS U INNER JOIN (SELECT TITLE, EXPLAIN, POST_FILE, USER_NO, POST_NO
		                        FROM POST
		                        WHERE DEL = 1
		                        AND VISIBILITY = 0
		                        AND CATEGORY_NO = 2) P
		                ON U.USER_NO = P.USER_NO
		WHERE U.OUT_DATE IS NULL
	</select>

</mapper>