<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Srh"><!-- namespace - 클래스명과 동일 -->
	<!-- id - 메소드명과 동일 -->
	<!-- resultType : row 1줄의 형태를 지정 -->
	<!-- 쿼리 작성 시 ;이 들어가면 실행되지 않음 -->

	<select id="getSCnt" parameterType="hashmap" resultType="Integer">
		SELECT COUNT(*) AS CNT
		FROM POST P
		LEFT OUTER JOIN(SELECT USER_NO, USER_ID, USER_NICKNAME, INTRODUCE
                         FROM USERS
                         WHERE OUT_DATE IS NULL) U
 		ON P.USER_NO = U.USER_NO
		WHERE 1 = 1
		AND P.DEL = 1 AND P.VISIBILITY = 0	
		<if test="searchTxt != null and searchTxt != ''">
			<choose>
				<when test="tabFlag == 0">
					AND P.CATEGORY_NO = 1
					AND (P.TITLE LIKE '%' || #{searchTxt} || '%'
					OR P.EXPLAIN LIKE '%' || #{searchTxt} || '%')				
				</when>
				<when test="tabFlag == 1">
					AND P.CATEGORY_NO = 2
					AND (P.TITLE LIKE '%' || #{searchTxt} || '%'
					OR P.EXPLAIN LIKE '%' || #{searchTxt} || '%')		
				</when>
				<when test="tabFlag == 2">
					AND P.CATEGORY_NO = 3
					AND (P.TITLE LIKE '%' || #{searchTxt} || '%'
					OR P.EXPLAIN LIKE '%' || #{searchTxt} || '%')	
				</when>
				<when test="tabFlag == 3">
					AND U.NAME LIKE '%' || #{searchTxt} || '%'
				</when>
			</choose>
		</if>
	</select>
	
	<select id="getSearchList" parameterType="hashmap" resultType="Integer">
		SELECT P.POST_NO, P.USER_NO, P.CATEGORY_NO, P.TITLE,
				P.EXPLAIN, P.POST_FILE, P.VISIBILITY, P.VIEWS,
				P.REGISTER_DATE, P.DEL, P.VIDEO_LINK, P.LIKE_CNT, U.USER_ID, USER_NICKNAME, U.INTRODUCE, U.PROFILE_IMG_PATH
		FROM (SELECT P.POST_NO, P.USER_NO, P.CATEGORY_NO, P.TITLE,
				P.EXPLAIN, P.POST_FILE, P.VISIBILITY, P.VIEWS,
				P.REGISTER_DATE, P.DEL, P.VIDEO_LINK, DECODE(L.LIKE_CNT, NULL, 0, L.LIKE_CNT) AS LIKE_CNT
		        FROM POST P LEFT OUTER JOIN (SELECT POST_NO, COUNT(*) LIKE_CNT
		                                        FROM POST_LIKE
		                                        GROUP BY POST_NO) L
		                                ON P.POST_NO = L.POST_NO
		        						AND P.DEL = 1 AND P.VISIBILITY = 0) P
		LEFT OUTER JOIN (SELECT USER_NO, USER_ID, USER_NICKNAME, INTRODUCE, PROFILE_IMG_PATH
		                                                FROM USERS
		                                                WHERE OUT_DATE IS NULL) U
		ON P.USER_NO = U.USER_NO
		WHERE 1 = 1
		<if test="searchTxt != null and searchTxt != ''">
			<choose>
				<when test="tabFlag == 0">
					AND P.CATEGORY_NO = 1
					AND (P.TITLE LIKE '%' || #{searchTxt} || '%'
					OR P.EXPLAIN LIKE '%' || #{searchTxt} || '%')				
				</when>
				<when test="tabFlag == 1">
					AND P.CATEGORY_NO = 2
					AND (P.TITLE LIKE '%' || #{searchTxt} || '%'
					OR P.EXPLAIN LIKE '%' || #{searchTxt} || '%')		
				</when>
				<when test="tabFlag == 2">
					AND P.CATEGORY_NO = 3
					AND (P.TITLE LIKE '%' || #{searchTxt} || '%'
					OR P.EXPLAIN LIKE '%' || #{searchTxt} || '%')	
				</when>
				<when test="tabFlag == 3">
					AND U.USER_NICKNAME LIKE '%' || #{searchTxt} || '%'
				</when>
			</choose>
		</if>
		<if test="searchTxt != null and searchTxt != ''
			and orderFlag!= null and orderFlag != ''">
			<choose>
				<when test="orderFlag == 0">
					ORDER BY P.LIKE_CNT DESC	
				</when>
				<when test="orderFlag == 1">
					ORDER BY P.VIEWS DESC		
				</when>
				<when test="orderFlag == 2">
					ORDER BY P.REGISTER_DATE DESC	
				</when>
			</choose>
		</if>
	</select>































</mapper>